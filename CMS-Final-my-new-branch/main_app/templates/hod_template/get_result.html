{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{ page_title }}{% endblock page_title %}
{% block custom_css %}
<style>
    .attendance_div_red {
        padding: 10px;
        background: #f44336;
        border: 3px solid white;
        text-align: center;
        color: #fff;
        border-radius: 30px;
        box-shadow: 1px 1px 1px grey;
        margin: 5px;
    }

    .attendance_div_green {
        padding: 10px;
        background: #4CAF50;
        border: 3px solid white;
        text-align: center;
        color: #fff;
        border-radius: 30px;
        box-shadow: 1px 1px 1px grey;
        margin: 5px;
    }
</style>
{% endblock custom_css %}
{% block content %}

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <!-- general form elements -->
                <div class="card card-dark">
                    <div class="card-header">
                        <h3 class="card-title">{{ page_title }}</h3>
                    </div>

                    <!-- /.card-header -->
                    <!-- form start -->
                    <div class="card-body">
                        <div class="form-group">
                            <label>Subjects</label>
                            <select name="course" class="form-control" id='subject'>
                                <option value="">----</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Batch</label>
                            <select name="session" class="form-control" id='session'>
                                <option value="">----</option>
                                {% for session in sessions %}
                                <option value="{{ session.id }}">{{ session }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <div style="display: none;" class="alert alert-danger" id='error_attendance'></div>
                            <div class="alert alert-success" id='success_attendance' style="display: none;"></div>
                            <button type="button" id='fetch_results' class="btn btn-success btn-block">Fetch Results</button>
                        </div>
                    </div>
                    <!-- /.card-body -->
                </div>
                <!-- /.card -->
            </div>
        </div>
    </div>
</section>

<div style="height: 400px; overflow: auto;">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Name</th>
                <th scope="col">Test Score</th>
                <th scope="col">Exam Score</th>
                <th scope="col">Total</th>
            </tr>
        </thead>
        <tbody id="result_table_body">
            <!-- Results will be dynamically added here -->
        </tbody>
    </table>
</div>

{% endblock content %}

{% block custom_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('#fetch_results').click(function() {
        var subject_id = $('#subject').val();
        var session_id = $('#session').val();

        if (subject_id && session_id) {
            $.ajax({
                url: '{% url "sort_results" %}',
                type: 'GET',
                data: {
                    'subject_id': subject_id,
                    'session_id': session_id
                },
                dataType: 'json',
                success: function(response) {
                    if (response.sorted_results) {
                        $('#error_attendance').hide();
                        $('#success_attendance').show().html('Results fetched successfully.');
                        // Clear previous results
                        $('#result_table_body').empty();
                        // Iterate through the sorted results and append them to the table
                        $.each(response.sorted_results, function(index, result) {
                            var total = parseFloat(result.test) + parseFloat(result.exam);
                            $('#result_table_body').append('<tr><th scope="row">' + (index + 1) + '</th><td>' + result.student_name + '</td><td>' + result.test + '</td><td>' + result.exam + '</td><td>' + total + '</td></tr>');
                        });
                    } else {
                        $('#success_attendance').hide();
                        $('#error_attendance').show().html('Failed to fetch results.');
                    }
                },
                error: function(xhr, errmsg, err) {
                    $('#success_attendance').hide();
                    $('#error_attendance').show().html('Failed to fetch results.');
                }
            });
        } else {
            $('#success_attendance').hide();
            $('#error_attendance').show().html('Please select both Subject and Session.');
        }
    });
});
</script>
{% endblock custom_js %}
